<!DOCTYPE html>
<html>
<head>
    <title>Guirong</title>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
    <meta name="mobile-web-app-capable" content="yes">
    <!--ref: https://developer.chrome.com/multidevice/android/installtohomescreen-->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="description" content="请先扫码体验(天猫app体验最佳)：

体验完产品，具体讲下技术实现方案，整体的实现过程可以分为：
拍照-&gt;获得图片数据-&gt;将商品与图片合成-&gt;生成效果图-&gt;用户保存图片
拍照
跨终端调取摄像头
这是试戴的关键一步，考虑到需要支持到各个终端，所以优先想到使用标准的web方案来实现：WebRTC-getUserMedia
基于getUserMedia，面向mobile 快速尝">
<meta property="og:type" content="article">
<meta property="og:title" content="跨终端实践-天猫试戴的解决方案">
<meta property="og:url" content="http://guirong.github.io/2014/10/crossend-tmalltry.html">
<meta property="og:site_name" content="Guirong">
<meta property="og:description" content="请先扫码体验(天猫app体验最佳)：

体验完产品，具体讲下技术实现方案，整体的实现过程可以分为：
拍照-&gt;获得图片数据-&gt;将商品与图片合成-&gt;生成效果图-&gt;用户保存图片
拍照
跨终端调取摄像头
这是试戴的关键一步，考虑到需要支持到各个终端，所以优先想到使用标准的web方案来实现：WebRTC-getUserMedia
基于getUserMedia，面向mobile 快速尝">
<meta property="og:image" content="http://gtms01.alicdn.com/tps/i1/TB1MuH0FVXXXXa_XFXXUvtM3pXX-540-548.png">
<meta property="og:image" content="http://gtms03.alicdn.com/tps/i3/TB1gyk_FFXXXXaiapXXa6gN9XXX-660-990.jpg">
<meta property="og:image" content="http://gtms02.alicdn.com/tps/i2/TB1UCm7FVXXXXaOXVXX0EopGFXX-912-422.png">
<meta property="og:image" content="http://gtms03.alicdn.com/tps/i3/TB1owqyFVXXXXcBaXXXwRYt9XXX-660-342.png">
<meta property="og:image" content="http://gtms02.alicdn.com/tps/i2/TB1kljdFVXXXXawaXXX5tMtNFXX-608-408.jpg">
<meta property="og:image" content="http://gtms04.alicdn.com/tps/i4/TB1Psa_FVXXXXcOXFXX4oiYGpXX-670-415.jpg">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="跨终端实践-天猫试戴的解决方案">
<meta name="twitter:description" content="请先扫码体验(天猫app体验最佳)：

体验完产品，具体讲下技术实现方案，整体的实现过程可以分为：
拍照-&gt;获得图片数据-&gt;将商品与图片合成-&gt;生成效果图-&gt;用户保存图片
拍照
跨终端调取摄像头
这是试戴的关键一步，考虑到需要支持到各个终端，所以优先想到使用标准的web方案来实现：WebRTC-getUserMedia
基于getUserMedia，面向mobile 快速尝">

    
    <link rel="alternative" href="/feed.xml" title="Guirong" type="application/atom+xml">
    
    <link rel="icon" href="/favicon32.png" type="image/png" />
    <link rel="stylesheet" href="/style.css" type="text/css">
<link rel="stylesheet" href="/highlight.css" type="text/css">

    <!--[if lte IE 8]>
    <!-- @todo -->
    <![endif]-->
</head>
<body>
<div id="main">
    <header>
        <h1>Guirong</h1>
        <div class="line r"></div>
        <div class="line g"></div>
        <div class="line b"></div>
    </header>
    <nav>
        <a  href="/">Home</a>
        <a  href="/tags.html">Tags</a>
        <a  href="/read.html">Read</a>
        <a  href="/about.html">About</a>
        <a href="/feed.xml">Feed</a>
    </nav>
<article id="content" class="article-entry">
    <h2>跨终端实践-天猫试戴的解决方案</h2>
    <section class="post">
        <p>请先扫码体验(天猫app体验最佳)：<img src="http://gtms01.alicdn.com/tps/i1/TB1MuH0FVXXXXa_XFXXUvtM3pXX-540-548.png" width="20"></p>
<p><img src="http://gtms03.alicdn.com/tps/i3/TB1gyk_FFXXXXaiapXXa6gN9XXX-660-990.jpg" alt=""></p>
<p>体验完产品，具体讲下技术实现方案，整体的实现过程可以分为：</p>
<p><code>拍照-&gt;获得图片数据-&gt;将商品与图片合成-&gt;生成效果图-&gt;用户保存图片</code></p>
<h3 id="拍照">拍照</h3>
<h4 id="跨终端调取摄像头">跨终端调取摄像头</h4>
<p>这是试戴的关键一步，考虑到需要支持到各个终端，所以优先想到使用标准的web方案来实现：WebRTC-<code>getUserMedia</code></p>
<p>基于getUserMedia，面向mobile 快速尝试，基本完成了主要的功能</p>
<p>但getUserMedia的支持情况并不理想，尤其是sarfari的不支持让广大ios/mac用户无法体验，这里就需要PC、mobile的兼容处理，以跨终端<a href="http://static.lukew.com/MobileFirst_LukeW.pdf" target="_blank" rel="external">mobile first</a>及<a href="http://ued.taobao.org/blog/2008/10/understanding-progressiveen-hancement-chs-translation/" target="_blank" rel="external">优雅退化</a>的思路设计兼容API：</p>
<ol>
<li>在浏览器中如果无法支持，将采用flash方案补齐</li>
<li>在native中，优先采用native api 补齐</li>
</ol>
<p><img src="http://gtms02.alicdn.com/tps/i2/TB1UCm7FVXXXXaOXVXX0EopGFXX-912-422.png" width="660"></p>
<h4 id="控制前后摄像头（web）">控制前后摄像头（web）</h4>
<p>对于戒指的试戴，手机上我们期望优先调用后置摄像头，在web中启动时就需要设置优先后置摄像头，<a href="http://dev.w3.org/2011/webrtc/editor/getusermedia.html#widl-MediaTrackConstraintSet-sourceId" target="_blank" rel="external">W3C文档</a>还处于Draft阶段，相对还不是特别完善，可以通过如下设置：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">{</div><div class="line">	video:{</div><div class="line">		optional: [</div><div class="line">			{</div><div class="line">				sourceId: $sourceId</div><div class="line">			}</div><div class="line">		]</div><div class="line">	}</div><div class="line">}</div></pre></td></tr></table></figure>

<p>通过<code>MediaStreamTrack.getSources</code>可获得设备的所有sourceId，注意：考虑设备可能没有外设如台式机或外设设备不可用(在虚拟机或远程)，这种情况下会报错，所以需要try&amp;catach容错。</p>
<h4 id="控制拍照时图片尺寸(web)">控制拍照时图片尺寸(web)</h4>
<p>不同的终端，摄像头拍摄的图片照片尺寸是不同的，如果我们只需要获得某一部分图像，就需要对图像做剪裁，在WEB中为了不引起用户疑惑，展现给用户拍照界面时，所见最好就是所需要的部分</p>
<p>举个栗子：我们期望获得一个正方形的图片，但是rmbp中摄像原始是16：9的图像，考虑方案有：</p>
<ol>
<li>考虑设置video的width/height 让图像自动充满video(参考官方文档并没有规定这部分实现，最新草案也无方向，这个方案走不通)</li>
<li>将video部分隐藏，知道目前图像的原始尺寸，然后垂直居中，方式如图：</li>
</ol>
<p><img src="http://gtms03.alicdn.com/tps/i3/TB1owqyFVXXXXcBaXXXwRYt9XXX-660-342.png" alt=""></p>
<p>需要注意的是：video API中有 videoHeight及videoWidth两个属性，当video play时理论这两个属性就是当前图像的宽高，但实际情况<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=926753" target="_blank" rel="external">Mozilla存在一个bug#926753</a>，play时仍无法准确获取，兼容的方案轮训监听：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Event.on(video,<span class="string">"play"</span>,<span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">	<span class="keyword">if</span>(<span class="keyword">this</span>.videoHeight===<span class="number">0</span>){</div><div class="line">        <span class="keyword">return</span> S.later(<span class="built_in">arguments</span>.callee,<span class="number">100</span>,<span class="literal">false</span>,<span class="keyword">this</span>);</div><div class="line">    }</div><div class="line">    <span class="comment">// now width/height ok</span></div><div class="line">}</div></pre></td></tr></table></figure>

<h3 id="获取数据：_在传输大数据情况下的web与native通讯">获取数据： 在传输大数据情况下的web与native通讯</h3>
<p>在拍照完成native中需要把图片数据传递给web，另外用户保存图片到本地时，web又需要把合成好的图片数据传递给native让其保存，这边涉及native与web的传递大数据通讯：</p>
<ol>
<li>native -&gt; web: <ol>
<li>android：可通过<code>WebView#addJavascriptInterface()</code>向web注入js方法 ,</li>
<li>ios：可通过<code>UIWebView#stringByEvaluatingJavaScriptFromString()</code>执行js函数，两种方式向web传递大数据都没有问题</li>
</ol>
</li>
<li>web -&gt; native: <ol>
<li>android：由于可以把native类暴露给web，js可以调用暴露的方法和native通讯，大数据也没问题；</li>
<li>ios：由于是采用UIWebViewDelegate方式，监控request方式通信，js通过自定义协议的URL用iframe请求，传输大量数据时便存在问题；解决这个问题方案：既然native可以和web顺畅通信，就可以通知native一个js 函数名，让native自己来取。</li>
</ol>
</li>
</ol>
<p><img src="http://gtms02.alicdn.com/tps/i2/TB1kljdFVXXXXawaXXX5tMtNFXX-608-408.jpg" width="660"></p>
<h3 id="合成展现：定位戒指位置">合成展现：定位戒指位置</h3>
<p>比较简单，用图片说明: <code>picWidth/maskWidth = x1/x = w1/w</code><br><img src="http://gtms04.alicdn.com/tps/i4/TB1Psa_FVXXXXcOXFXX4oiYGpXX-670-415.jpg" width="660"></p>
<h3 id="生成图片：Canvas图片跨域">生成图片：Canvas图片跨域</h3>
<p>知道了具体位置，生成图片便可以简单的调用 <code>canvas.toDataURL</code>获得图片数据，但这里涉及一个图片跨域问题：<br>Canvas获取图片数据会有跨域的限制，之前有：<a href="http://gallery.kissyui.com/imgProxy/1.0/guide/index.html" target="_blank" rel="external">imageProxy</a> flash来做代理的方案，但是这个方案仍然不够高效和简洁，尤其是对于mobile更无能为力</p>
<p>最好的方案是web标准的CORS，通过让服务器返回allow-origin的header，让canvas可以正常处理：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// http response header: Access-Control-Allow-Origin: *</span></div><div class="line"></div><div class="line">img.crossOrigin = <span class="string">"Anonymous"</span>;</div><div class="line">img.onload = <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>{ </div><div class="line">	ctx.drawImage( img, <span class="number">0</span>, <span class="number">0</span> );</div><div class="line">	canvas.toDataURL(<span class="string">"image/png"</span>);</div><div class="line">}</div></pre></td></tr></table></figure>

<h3 id="组件化&amp;Mobile_First">组件化&amp;Mobile First</h3>
<p>在整个开发的过程中是以组件化的思路分层处理，并封装成了具体的组件，通过封装的组件，后续拍照、试戴可以快速搭建完成，除了天猫自身业务特色的组件外，比较通用的有：</p>
<ol>
<li>camera组件: 底层跨终端拍照组件，后续会移植到阿里HybirdAPI一部分</li>
<li>try组件: 上层的试戴组件，处理图片位置、合并、移动旋转等，可配置不同模板及参数快速支持其他类型试戴（如眼镜）</li>
</ol>
<p>再设计跨终端有组件时，经验是优先面向mobile设计，这样逻辑及交互流程更加简洁，可以让API涉及更加清晰，后续正对PC适当兼容。</p>
<h3 id="聊业务">聊业务</h3>
<p>最后简单聊下这个业务：这是一个技术驱动业务的项目，从初期的业务重点在频道，中间经历几次业务调整，到目前把试戴作为业务后续的重点，可以说这个产品在其中起到了很多的作用，其中几点经验：</p>
<ol>
<li>不仅自己看到价值，重要让合作伙伴也看到价值<ol>
<li>在资源有限的情况下，作为技术人员去影响业务策略是不易的，认同事情的价值是关键一步</li>
</ol>
</li>
<li>快速的产出demo，验证可行性及让合作伙伴了解成本及效果<ol>
<li>有时不是业务看不到方向而是担心成本，这是技术的优势，但需要做出来看</li>
</ol>
</li>
</ol>
<h3 id="后续">后续</h3>
<p>后续试戴还有很多地方可以发力，比较重要的一些方向：</p>
<ol>
<li>支持更多品类：项链、眼镜、耳环、手镯、手表等其他类目</li>
<li>可以考虑结合图像搜索做相关推荐</li>
<li>尝试使用图像识别，减少已有模板对比的成本，<a href="http://mtschirs.github.io/js-objectdetect/examples/example_sunglasses_jquery.htm" target="_blank" rel="external">example</a></li>
</ol>
<h3 id="附">附</h3>
<ol>
<li><a href="http://www.html5rocks.com/zh/tutorials/video/basics/" target="_blank" rel="external">html5 vedio 简介</a></li>
<li><a href="http://www.html5rocks.com/en/tutorials/getusermedia/intro/" target="_blank" rel="external">Capturing Audio &amp; Video in HTML5</a></li>
<li><a href="http://caniuse.com/#feat=stream" target="_blank" rel="external">getUserMedia兼容性</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/HTML/CORS_enabled_image#What_is_a_.22tainted.22_canvas.3F" target="_blank" rel="external">tainted canvas</a></li>
<li><a href="http://wesbos.com/html5-video-face-detection-canvas-javascript/" target="_blank" rel="external">html5 video face detection</a></li>
<li><a href="http://caowenhao.sinaapp.com/" target="_blank" rel="external">html5 肤色检测</a></li>
</ol>

    </section>
    <section class="meta">

<span class="time">
  posted at <time datetime="2014-10-11T19:03:56.000Z" itemprop="datePublished">2014-10-12</time>
</span>
    </section>

    
    <section class="comment">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        </div>
    </section>
    

    
    <script>
        var disqus_shortname = 'guirong';
        
        var disqus_url = 'http://guirong.github.io/2014/10/crossend-tmalltry.html';
        
        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    


</article>
<footer>
    © 2014 Guirong Cao.
</footer>
</div>

</body>
</html>
